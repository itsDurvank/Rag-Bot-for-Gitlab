flowchart TD
    Start(["ğŸš€ Application Start"]) --> LoadConfig["ğŸ”§ Load Streamlit Config<br>Page Setup"]
    LoadConfig --> CheckAPI{"ğŸ” Google API Key<br>Available?"}
    
    CheckAPI -->|No| ErrorAPI["âŒ Display API Error<br>Stop Application"]
    CheckAPI -->|Yes| LoadVectorStore["ğŸ“š Load FAISS Vector Store<br>@st.cache_resource"]
    
    LoadVectorStore --> InitComponents["âš™ï¸ Initialize Components:<br>- Gemini LLM<br>- Memory Buffer<br>- Retriever (MMR)<br>- QA Chain"]
    
    InitComponents --> DisplayUI["ğŸ–¥ï¸ Render Streamlit UI:<br>- Title & Description<br>- Chat History<br>- Input Field"]
    
    DisplayUI --> WaitInput["â³ Wait for User Input"]
    
    WaitInput --> UserQuery{"ğŸ’¬ User Query<br>Received?"}
    UserQuery -->|No| WaitInput
    UserQuery -->|Yes| DisplayUserMsg["ğŸ‘¤ Display User Message<br>in Chat"]
    
    DisplayUserMsg --> ShowSpinner["â³ Show Spinner:<br>ğŸ¤– Thinking..."]
    ShowSpinner --> ProcessQuery["ğŸ”„ Process Query through<br>ConversationalRetrievalChain"]
    
    ProcessQuery --> RetrieveContext["ğŸ” Retrieve Relevant Context:<br>- Search FAISS with MMR<br>- Get top 8 chunks<br>- Include metadata"]
    
    RetrieveContext --> PreparePrompt["ğŸ“ Prepare Prompt:<br>- Context from retrieval<br>- User question<br>- Chat history from memory"]
    
    PreparePrompt --> CallGemini["ğŸ¤– Call Gemini 1.5 Flash API<br>with prepared prompt"]
    
    CallGemini --> Success{"âœ… API Call<br>Successful?"}
    
    Success -->|No| DisplayError["âŒ Display Error Message<br>Exception Details"]
    Success -->|Yes| DisplayResponse["ğŸ¤– Display Bot Response<br>in Chat"]
    
    DisplayResponse --> ShowSources["ğŸ“š Show Sources in Expander:<br>- Document metadata<br>- Section information<br>- Content preview"]
    
    ShowSources --> UpdateMemory["ğŸ§  Update Conversation Memory<br>with Q&A pair"]
    UpdateMemory --> UpdateHistory["ğŸ“ Update Session State<br>Chat History"]
    
    UpdateHistory --> WaitInput
    DisplayError --> WaitInput
    
    %% Memory Management Subprocess
    subgraph MemoryMgmt ["Memory Management"]
        MemoryCheck{"ğŸ§  Memory Buffer<br>Full?"}
        MemoryCheck -->|Yes| Summarize["ğŸ“„ Summarize Old<br>Conversations"]
        MemoryCheck -->|No| KeepMemory["ğŸ’¾ Keep All Memory"]
        Summarize --> KeepMemory
    end
    
    UpdateMemory --> MemoryMgmt
    MemoryMgmt --> UpdateHistory
    
    %% Styling
    classDef startEnd fill:#e8f5e8,stroke:#2e7d32,stroke-width:3px,color:#000000,font-weight:bold;
    classDef process fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000000,font-weight:bold;
    classDef decision fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000000,font-weight:bold;
    classDef error fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#000000,font-weight:bold;
    classDef memory fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000000,font-weight:bold;
    classDef user fill:#e1f5fe,stroke:#0277bd,stroke-width:2px,color:#000000,font-weight:bold;
    
    class Start,ErrorAPI startEnd
    class LoadConfig,LoadVectorStore,InitComponents,DisplayUI,ProcessQuery,RetrieveContext,PreparePrompt,CallGemini,DisplayResponse,ShowSources,UpdateHistory process
    class CheckAPI,UserQuery,Success,MemoryCheck decision
    class DisplayError error
    class UpdateMemory,Summarize,KeepMemory memory
    class DisplayUserMsg,ShowSpinner,WaitInput user
